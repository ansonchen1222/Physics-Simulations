<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Window Air Conditioner Cycle Simulation (HD)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Custom Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #dbeafe;
            border-radius: 4px;
        }

        canvas {
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
            background: white;
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4">

    <div class="absolute top-4 right-4 flex gap-2 z-10">
        <button type="button" data-lang-switch="en-US"
            class="px-3 py-1 text-xs font-semibold border border-slate-200 rounded-full bg-white/70 text-slate-600 hover:bg-white hover:text-slate-900 transition"
            data-i18n="languageButtonEnglish">EN</button>
        <button type="button" data-lang-switch="zh-HK"
            class="px-3 py-1 text-xs font-semibold border border-slate-200 rounded-full bg-white/70 text-slate-600 hover:bg-white hover:text-slate-900 transition"
            data-i18n="languageButtonChinese">ÁπÅ</button>
    </div>

    <!-- Header -->
    <header class="w-full max-w-5xl mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-800" data-i18n="headerTitle">Window Air Conditioner Cycle</h1>
            <p class="text-slate-500 text-sm" data-i18n="headerSubtitle">Physics Simulation: Vapor Compression Cycle</p>
        </div>
        <div class="flex gap-4">
            <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center shadow-sm border border-blue-200">
                <div class="text-xs uppercase tracking-wider font-semibold" data-i18n="indoorTempLabel">Indoor
                    Temperature</div>
                <div class="text-2xl font-bold" id="indoorTempDisplay">28.0¬∞C</div>
            </div>
            <div
                class="bg-orange-100 text-orange-800 px-4 py-2 rounded-lg text-center shadow-sm border border-orange-200">
                <div class="text-xs uppercase tracking-wider font-semibold" data-i18n="outdoorTempLabel">Outdoor
                    Temperature</div>
                <div class="text-2xl font-bold">32.0¬∞C</div>
            </div>
        </div>
    </header>

    <!-- Main Simulation Area -->
    <main
        class="relative w-full max-w-5xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row border border-slate-200">

        <!-- Canvas Container -->
        <div class="relative flex-grow bg-slate-50 p-4 flex justify-center items-center min-h-[500px]">

            <!-- Background Dividers (Indoor/Outdoor) -->
            <div class="absolute inset-0 flex pointer-events-none">
                <div
                    class="w-1/2 h-full bg-blue-50/50 border-r-2 border-dashed border-slate-300 flex items-start justify-center pt-4">
                    <span class="text-blue-300 font-bold text-4xl opacity-20 select-none"
                        data-i18n="indoorBackdrop">Indoor</span>
                </div>
                <div class="w-1/2 h-full bg-orange-50/50 flex items-start justify-center pt-4">
                    <span class="text-orange-300 font-bold text-4xl opacity-20 select-none"
                        data-i18n="outdoorBackdrop">Outdoor</span>
                </div>
            </div>

            <!-- The Canvas -->
            <canvas id="simCanvas"></canvas>
        </div>

        <!-- Sidebar Controls & Info -->
        <div class="w-full md:w-80 bg-slate-50 border-l border-slate-200 p-6 flex flex-col gap-6">

            <!-- Controls -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <label class="block text-sm font-bold text-slate-700 mb-2 flex justify-between">
                    <span data-i18n="powerLabel">Cooling Power</span>
                    <span id="powerValue" class="text-blue-600">0%</span>
                </label>
                <input type="range" id="powerSlider" min="0" max="100" value="0" step="1">
                <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span data-i18n="powerMin">Off</span>
                    <span data-i18n="powerMax">Max</span>
                </div>
            </div>

            <!-- Legend / Status -->
            <div class="flex-grow space-y-3">
                <h3 class="font-bold text-slate-700 border-b pb-2 text-sm" data-i18n="legendHeading">Refrigerant States
                </h3>

                <!-- State 1 -->
                <div class="flex items-center gap-3 text-sm bg-white p-2 rounded border border-slate-100 shadow-sm">
                    <div class="w-4 h-4 rounded-full bg-red-500 flex-shrink-0 animate-pulse border border-red-600">
                    </div>
                    <div>
                        <span class="font-bold text-slate-800 block text-xs" data-i18n="state1Title">High-temperature
                            high-pressure gas</span>
                        <span class="text-slate-500 text-[10px]" data-i18n="state1Flow">Compressor ‚ûî Condenser</span>
                    </div>
                </div>

                <!-- State 2 -->
                <div class="flex items-center gap-3 text-sm bg-white p-2 rounded border border-slate-100 shadow-sm">
                    <div class="w-4 h-4 rounded-full bg-orange-500 flex-shrink-0 border border-orange-600"></div>
                    <div>
                        <span class="font-bold text-slate-800 block text-xs" data-i18n="state2Title">Medium-temperature
                            high-pressure liquid</span>
                        <span class="text-slate-500 text-[10px]" data-i18n="state2Flow">Condenser ‚ûî Expansion
                            Valve</span>
                    </div>
                </div>

                <!-- State 3 -->
                <div class="flex items-center gap-3 text-sm bg-white p-2 rounded border border-slate-100 shadow-sm">
                    <div class="w-4 h-4 rounded-full bg-cyan-300 flex-shrink-0 border border-cyan-400"></div>
                    <div>
                        <span class="font-bold text-slate-800 block text-xs" data-i18n="state3Title">Low-temperature
                            low-pressure liquid (mixture)</span>
                        <span class="text-slate-500 text-[10px]" data-i18n="state3Flow">Expansion Valve ‚ûî
                            Evaporator</span>
                    </div>
                </div>

                <!-- State 4 -->
                <div class="flex items-center gap-3 text-sm bg-white p-2 rounded border border-slate-100 shadow-sm">
                    <div
                        class="w-4 h-4 rounded-full bg-blue-500 flex-shrink-0 border-2 border-white ring-1 ring-blue-500">
                    </div>
                    <div>
                        <span class="font-bold text-slate-800 block text-xs" data-i18n="state4Title">Low-temperature
                            low-pressure gas</span>
                        <span class="text-slate-500 text-[10px]" data-i18n="state4Flow">Evaporator ‚ûî Compressor</span>
                    </div>
                </div>
            </div>

            <!-- Theory Box -->
            <div
                class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-xs text-blue-800 leading-relaxed space-y-1.5">
                <strong data-i18n="theoryHeading">üí° Physics Principles:</strong>
                <ul class="list-disc pl-4 mt-1 space-y-1.5">
                    <li class="space-y-0.5">
                        <span class="font-bold block" data-i18n="theoryEvaporatorTitle">Evaporator (Absorbs Heat)</span>
                        <span data-i18n="theoryEvaporatorDesc">The refrigerant evaporates and absorbs heat from the
                            indoor air.</span>
                    </li>
                    <li class="space-y-0.5">
                        <span class="font-bold block" data-i18n="theoryCompressorTitle">Compressor (Work Input)</span>
                        <span data-i18n="theoryCompressorDesc">The vapor is compressed, rapidly increasing its
                            temperature and pressure.</span>
                    </li>
                    <li class="space-y-0.5">
                        <span class="font-bold block" data-i18n="theoryCondenserTitle">Condenser (Releases Heat)</span>
                        <span data-i18n="theoryCondenserDesc">Heat is rejected to the outdoor air and the vapor
                            condenses to liquid.</span>
                    </li>
                    <li class="space-y-0.5">
                        <span class="font-bold block" data-i18n="theoryValveTitle">Expansion Valve (Pressure
                            Drop)</span>
                        <span data-i18n="theoryValveDesc">Flow is restricted so the refrigerant suddenly drops in
                            pressure and temperature.</span>
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        const translations = {
            "en-US": {
                title: "Window Air Conditioner Cycle Simulation (HD)",
                headerTitle: "Window Air Conditioner Cycle",
                headerSubtitle: "Physics Simulation: Vapor Compression Cycle",
                indoorTempLabel: "Indoor Temperature",
                outdoorTempLabel: "Outdoor Temperature",
                indoorBackdrop: "Indoor",
                outdoorBackdrop: "Outdoor",
                powerLabel: "Cooling Power",
                powerMin: "Off",
                powerMax: "Max",
                legendHeading: "Refrigerant States",
                state1Title: "High-temperature high-pressure gas",
                state1Flow: "Compressor ‚ûî Condenser",
                state2Title: "Medium-temperature high-pressure liquid",
                state2Flow: "Condenser ‚ûî Expansion Valve",
                state3Title: "Low-temperature low-pressure liquid (mixture)",
                state3Flow: "Expansion Valve ‚ûî Evaporator",
                state4Title: "Low-temperature low-pressure gas",
                state4Flow: "Evaporator ‚ûî Compressor",
                theoryHeading: "üí° Physics Principles:",
                theoryEvaporatorTitle: "Evaporator (Absorbs Heat)",
                theoryEvaporatorDesc: "The refrigerant evaporates and absorbs heat from the indoor air.",
                theoryCompressorTitle: "Compressor (Work Input)",
                theoryCompressorDesc: "The vapor is compressed, rapidly increasing its temperature and pressure.",
                theoryCondenserTitle: "Condenser (Releases Heat)",
                theoryCondenserDesc: "Heat is rejected to the outdoor air and the vapor condenses to liquid.",
                theoryValveTitle: "Expansion Valve (Pressure Drop)",
                theoryValveDesc: "Flow is restricted so the refrigerant suddenly drops in pressure and temperature.",
                canvasCompressorLabel: "Compressor",
                canvasCompressorSubtitle: "Do work",
                canvasValveLabel: "Expansion Valve",
                canvasEvaporatorLabel: "Evaporator (Absorbs Heat)",
                canvasCondenserLabel: "Condenser (Releases Heat)",
                canvasColdAirLabel: "Cool Air",
                canvasHotAirLabel: "Warm Air",
                languageButtonEnglish: "EN",
                languageButtonChinese: "ÁπÅ"
            },
            "zh-HK": {
                title: "Á™óÂè£ÂºèÂÜ∑Ê∞£Ê©üÈÅã‰ΩúÂéüÁêÜÊ®°Êì¨ÔºàÈ´òÊ∏ÖÁâàÔºâ",
                headerTitle: "Á™óÂè£ÂºèÂÜ∑Ê∞£Ê©üÈÅã‰ΩúÂéüÁêÜ",
                headerSubtitle: "Áâ©ÁêÜÊ®°Êì¨ÔºöËí∏Ê∞£Â£ìÁ∏ÆÂæ™Áí∞",
                indoorTempLabel: "ÂÆ§ÂÖßÊ∫´Â∫¶",
                outdoorTempLabel: "ÂÆ§Â§ñÊ∫´Â∫¶",
                indoorBackdrop: "ÂÆ§ÂÖßÂçÄÂüü",
                outdoorBackdrop: "ÂÆ§Â§ñÂçÄÂüü",
                powerLabel: "ÈÅã‰ΩúÂäüÁéá",
                powerMin: "ÈóúÈñâ",
                powerMax: "ÊúÄÂ§ß",
                legendHeading: "Ë£ΩÂÜ∑ÂäëÁãÄÊÖã",
                state1Title: "È´òÊ∫´È´òÂ£ìÊ∞£È´î",
                state1Flow: "Â£ìÁ∏ÆÊ©ü ‚ûî ÂÜ∑ÂáùÂô®",
                state2Title: "‰∏≠Ê∫´È´òÂ£ìÊ∂≤È´î",
                state2Flow: "ÂÜ∑ÂáùÂô® ‚ûî ËÜ®ËÑπÈñ•",
                state3Title: "‰ΩéÊ∫´‰ΩéÂ£ìÊ∂≤È´îÔºàÊ∑∑ÂêàÔºâ",
                state3Flow: "ËÜ®ËÑπÈñ• ‚ûî Ëí∏ÁôºÂô®",
                state4Title: "‰ΩéÊ∫´‰ΩéÂ£ìÊ∞£È´î",
                state4Flow: "Ëí∏ÁôºÂô® ‚ûî Â£ìÁ∏ÆÊ©ü",
                theoryHeading: "üí° Áâ©ÁêÜÂéüÁêÜÔºö",
                theoryEvaporatorTitle: "Ëí∏ÁôºÂô®ÔºàÂê∏ÁÜ±Ôºâ",
                theoryEvaporatorDesc: "Ë£ΩÂÜ∑ÂäëÂú®Ëí∏ÁôºÂô®ÂÖßÊ±ΩÂåñ‰∏¶Âê∏Êî∂ÂÆ§ÂÖßÁÜ±Èáè„ÄÇ",
                theoryCompressorTitle: "Â£ìÁ∏ÆÊ©üÔºà‰ΩúÂäüÔºâ",
                theoryCompressorDesc: "Ê∞£È´îË¢´Â£ìÁ∏ÆÔºåÊ∫´Â∫¶ËàáÂ£ìÂäõÊÄ•ÈÄü‰∏äÂçá„ÄÇ",
                theoryCondenserTitle: "ÂÜ∑ÂáùÂô®ÔºàÊîæÁÜ±Ôºâ",
                theoryCondenserDesc: "ÁÜ±ÈáèÊéíÂêëÂÆ§Â§ñÔºåÊ∞£È´îÂáùÁµêÊàêÊ∂≤È´î„ÄÇ",
                theoryValveTitle: "ËÜ®ËÑπÈñ•ÔºàÈôçÂ£ìÔºâ",
                theoryValveDesc: "ÈôêÂà∂ÊµÅÈáèÔºå‰ΩøË£ΩÂÜ∑ÂäëÁû¨ÈñìÈôç‰ΩéÂ£ìÂäõËàáÊ∫´Â∫¶„ÄÇ",
                canvasCompressorLabel: "Â£ìÁ∏ÆÊ©ü",
                canvasCompressorSubtitle: "‰ΩúÂäü",
                canvasValveLabel: "ËÜ®ËÑπÈñ•",
                canvasEvaporatorLabel: "Ëí∏ÁôºÂô®ÔºàÂê∏ÁÜ±Ôºâ",
                canvasCondenserLabel: "ÂÜ∑ÂáùÂô®ÔºàÊîæÁÜ±Ôºâ",
                canvasColdAirLabel: "ÂÜ∑È¢®",
                canvasHotAirLabel: "ÁÜ±È¢®",
                languageButtonEnglish: "EN",
                languageButtonChinese: "ÁπÅ"
            }
        };

        let currentLang = "en-US";

        function getTranslation(key) {
            const dict = translations[currentLang] || translations["en-US"];
            return dict[key] || "";
        }

        function applyTranslations() {
            const dict = translations[currentLang] || translations["en-US"];
            document.documentElement.lang = currentLang;
            document.title = dict.title || document.title;

            document.querySelectorAll("[data-i18n]").forEach((el) => {
                const key = el.dataset.i18n;
                if (!key) return;
                const text = dict[key];
                if (typeof text !== "undefined") {
                    el.textContent = text;
                }
            });
        }

        function updateLangButtons() {
            document.querySelectorAll("[data-lang-switch]").forEach((btn) => {
                const isActive = btn.dataset.langSwitch === currentLang;
                btn.classList.toggle("text-slate-900", isActive);
                btn.classList.toggle("text-slate-600", !isActive);
                btn.classList.toggle("shadow-lg", isActive);
                btn.classList.toggle("bg-white", isActive);
                btn.classList.toggle("bg-white/70", !isActive);
                btn.classList.toggle("ring-1", isActive);
                btn.classList.toggle("ring-blue-400", isActive);
            });
        }

        function setLanguage(lang, skipUrlUpdate = false) {
            if (!translations[lang]) {
                lang = "en-US";
            }
            currentLang = lang;
            applyTranslations();
            updateLangButtons();

            if (!skipUrlUpdate) {
                const url = new URL(window.location);
                url.searchParams.set("lang", lang);
                window.history.pushState({}, "", url);
            }
        }

        function setupLanguageSwitcher() {
            document.querySelectorAll("[data-lang-switch]").forEach((btn) => {
                btn.addEventListener("click", () => {
                    setLanguage(btn.dataset.langSwitch);
                });
            });
        }

        function initLanguage() {
            setupLanguageSwitcher();
            const params = new URLSearchParams(window.location.search);
            const langParam = params.get("lang");
            const initialLang = translations[langParam] ? langParam : "en-US";
            setLanguage(initialLang, true);
        }

        initLanguage();

        // Simulation Configuration
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const indoorTempDisplay = document.getElementById('indoorTempDisplay');
        const powerSlider = document.getElementById('powerSlider');
        const powerValueText = document.getElementById('powerValue');

        const LOGICAL_WIDTH = 800;
        const LOGICAL_HEIGHT = 500;

        let power = 0;
        let roomTemp = 28.0;
        const outdoorTemp = 32.0;
        let frameCount = 0;

        const components = {
            evaporator: { x: 130, y: 200, w: 140, h: 200, label: "Evaporator", color: "#e0f2fe" },
            compressor: { x: 360, y: 60, w: 80, h: 80, label: "Compressor", color: "#334155" },
            condenser: { x: 530, y: 200, w: 140, h: 200, label: "Condenser", color: "#ffedd5" },
            expansionValve: { x: 380, y: 420, w: 40, h: 60, label: "Expansion Valve", color: "#94a3b8" }
        };

        function generateSPath(startX, startY, width, height, rows, direction) {
            const points = [];
            const rowHeight = height / rows;
            const inset = 20;

            if (direction === 'up') {
                for (let i = rows - 1; i >= 0; i--) {
                    const y = startY + (i * rowHeight) + rowHeight / 2;
                    if ((rows - 1 - i) % 2 === 0) {
                        points.push({ x: startX + inset, y });
                        points.push({ x: startX + width - inset, y });
                    } else {
                        points.push({ x: startX + width - inset, y });
                        points.push({ x: startX + inset, y });
                    }
                }
            } else {
                for (let i = 0; i < rows; i++) {
                    const y = startY + (i * rowHeight) + rowHeight / 2;
                    if (i % 2 === 0) {
                        points.push({ x: startX + inset, y });
                        points.push({ x: startX + width - inset, y });
                    } else {
                        points.push({ x: startX + width - inset, y });
                        points.push({ x: startX + inset, y });
                    }
                }
            }
            return points;
        }

        let paths = [];

        function initPaths() {
            const evapPoints = generateSPath(components.evaporator.x, components.evaporator.y, components.evaporator.w, components.evaporator.h, 5, 'up');
            evapPoints.push({ x: components.evaporator.x + 20, y: 100 });
            evapPoints.push({ x: components.compressor.x, y: 100 });

            const path1 = {
                points: evapPoints,
                color: "#3b82f6",
                innerColor: "#bfdbfe",
                state: "gas",
                tempBase: 5,
                width: 8
            };

            const path2 = {
                points: [
                    { x: components.compressor.x + components.compressor.w, y: 100 },
                    { x: components.condenser.x + 20, y: 100 },
                    { x: components.condenser.x + 20, y: components.condenser.y + 20 }
                ],
                color: "#ef4444",
                innerColor: "#fecaca",
                state: "gas",
                tempBase: 85,
                width: 8
            };

            const condPoints = generateSPath(components.condenser.x, components.condenser.y, components.condenser.w, components.condenser.h, 5, 'down');
            const lastCond = condPoints[condPoints.length - 1];
            condPoints.push({ x: lastCond.x, y: 450 });
            condPoints.push({ x: components.expansionValve.x + components.expansionValve.w, y: 450 });

            const path3 = {
                points: condPoints,
                color: "#f97316",
                innerColor: "#fed7aa",
                state: "liquid",
                tempBase: 45,
                width: 8
            };

            const path4 = {
                points: [
                    { x: components.expansionValve.x, y: 450 },
                    { x: components.evaporator.x + 20, y: 450 },
                    { x: components.evaporator.x + 20, y: components.evaporator.y + components.evaporator.h - 20 }
                ],
                color: "#22d3ee",
                innerColor: "#cffafe",
                state: "mix",
                tempBase: 2,
                width: 8
            };

            paths = [path1, path2, path3, path4];

            paths.forEach(p => {
                let len = 0;
                for (let i = 0; i < p.points.length - 1; i++) {
                    const dx = p.points[i + 1].x - p.points[i].x;
                    const dy = p.points[i + 1].y - p.points[i].y;
                    len += Math.sqrt(dx * dx + dy * dy);
                }
                p.totalLength = len;
            });
        }

        const particles = [];
        const maxParticles = 120;

        function init() {
            resizeCanvas();
            initPaths();

            for (let i = 0; i < maxParticles; i++) {
                particles.push({
                    pathIdx: Math.floor(Math.random() * 4),
                    distance: Math.random() * 100,
                });
            }

            window.addEventListener('resize', resizeCanvas);
            animate();
        }

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();

            canvas.width = LOGICAL_WIDTH * dpr;
            canvas.height = LOGICAL_HEIGHT * dpr;

            canvas.style.width = "100%";
            canvas.style.height = "auto";
            canvas.style.maxWidth = LOGICAL_WIDTH + "px";

            ctx.scale(dpr, dpr);
            const scaleX = rect.width / LOGICAL_WIDTH;
        }

        function drawPipePath(path) {
            if (path.points.length < 2) return;

            ctx.lineCap = "round";
            ctx.lineJoin = "round";

            ctx.beginPath();
            ctx.moveTo(path.points[0].x, path.points[0].y);
            for (let i = 1; i < path.points.length; i++) {
                ctx.lineTo(path.points[i].x, path.points[i].y);
            }
            ctx.strokeStyle = "#475569";
            ctx.lineWidth = path.width + 2;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(path.points[0].x, path.points[0].y);
            for (let i = 1; i < path.points.length; i++) {
                ctx.lineTo(path.points[i].x, path.points[i].y);
            }
            ctx.strokeStyle = path.innerColor;
            ctx.lineWidth = path.width;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(path.points[0].x, path.points[0].y);
            for (let i = 1; i < path.points.length; i++) {
                ctx.lineTo(path.points[i].x, path.points[i].y);
            }
            ctx.strokeStyle = "rgba(255,255,255,0.4)";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function drawComponents() {
            ctx.font = "bold 14px 'Noto Sans TC', sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            const comp = components.compressor;
            ctx.fillStyle = comp.color;
            ctx.beginPath();
            ctx.arc(comp.x + comp.w / 2, comp.y + comp.h / 2, 40, 0, Math.PI * 2);
            ctx.fill();
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#1e293b";
            ctx.stroke();

            ctx.fillStyle = "#fff";
            ctx.fillText(getTranslation("canvasCompressorLabel"), comp.x + comp.w / 2, comp.y + comp.h / 2 - 8);
            ctx.font = "10px sans-serif";
            ctx.fillText(getTranslation("canvasCompressorSubtitle"), comp.x + comp.w / 2, comp.y + comp.h / 2 + 8);

            const valve = components.expansionValve;
            ctx.fillStyle = valve.color;
            ctx.strokeStyle = "#475569";
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(valve.x, valve.y);
            ctx.lineTo(valve.x + valve.w, valve.y);
            ctx.lineTo(valve.x, valve.y + valve.h);
            ctx.lineTo(valve.x + valve.w, valve.y + valve.h);
            ctx.lineTo(valve.x, valve.y);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = "#1e293b";
            ctx.font = "bold 12px 'Noto Sans TC'";
            ctx.fillText(getTranslation("canvasValveLabel"), valve.x + valve.w / 2, valve.y + valve.h + 15);

            const evap = components.evaporator;
            ctx.fillStyle = "rgba(224, 242, 254, 0.5)";
            ctx.roundRect(evap.x - 10, evap.y - 10, evap.w + 20, evap.h + 20, 10);
            ctx.fill();
            ctx.fillStyle = "#0369a1";
            ctx.font = "bold 16px 'Noto Sans TC'";
            ctx.fillText(getTranslation("canvasEvaporatorLabel"), evap.x + evap.w / 2, evap.y - 25);

            const cond = components.condenser;
            ctx.fillStyle = "rgba(255, 237, 213, 0.5)";
            ctx.roundRect(cond.x - 10, cond.y - 10, cond.w + 20, cond.h + 20, 10);
            ctx.fill();
            ctx.fillStyle = "#c2410c";
            ctx.fillText(getTranslation("canvasCondenserLabel"), cond.x + cond.w / 2, cond.y - 25);

            if (power > 0) {
                ctx.fillStyle = `rgba(59, 130, 246, ${power / 100})`;
                ctx.font = "24px sans-serif";
                ctx.fillText("‚ùÑÔ∏è", evap.x - 30, evap.y + evap.h / 2);
                ctx.font = "14px sans-serif";
                ctx.fillText(getTranslation("canvasColdAirLabel"), evap.x - 30, evap.y + evap.h / 2 + 20);

                ctx.fillStyle = `rgba(239, 68, 68, ${power / 100})`;
                ctx.font = "24px sans-serif";
                ctx.fillText("‚ô®Ô∏è", cond.x + cond.w + 30, cond.y + cond.h / 2);
                ctx.font = "14px sans-serif";
                ctx.fillText(getTranslation("canvasHotAirLabel"), cond.x + cond.w + 30, cond.y + cond.h / 2 + 20);
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                const path = paths[p.pathIdx];

                let progress = p.distance / path.totalLength;

                if (progress >= 1) {
                    p.pathIdx = (p.pathIdx + 1) % 4;
                    p.distance = 0;
                    progress = 0;
                }

                let currentDist = 0;
                let targetX = 0, targetY = 0;

                for (let i = 0; i < path.points.length - 1; i++) {
                    const p1 = path.points[i];
                    const p2 = path.points[i + 1];
                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    const segLen = Math.sqrt(dx * dx + dy * dy);

                    if (currentDist + segLen >= p.distance) {
                        const segProg = (p.distance - currentDist) / segLen;
                        targetX = p1.x + dx * segProg;
                        targetY = p1.y + dy * segProg;
                        break;
                    }
                    currentDist += segLen;
                }

                ctx.fillStyle = path.color;
                let radius = 3;

                if (path.state === 'gas') {
                    ctx.globalAlpha = 0.7;
                    radius = 4;
                    targetX += (Math.random() - 0.5) * 2;
                    targetY += (Math.random() - 0.5) * 2;
                } else {
                    ctx.globalAlpha = 1.0;
                    radius = 3;
                }

                ctx.beginPath();
                ctx.arc(targetX, targetY, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;

                if (power > 0) {
                    const speed = 1.5 + (power / 100) * 2.5;
                    p.distance += speed;
                }
            });
        }

        function drawFloatLabels() {
            paths.forEach((path, idx) => {
                let sampleDist = path.totalLength / 2;
                let currentDist = 0;
                let labelX = 0, labelY = 0;

                for (let i = 0; i < path.points.length - 1; i++) {
                    const p1 = path.points[i];
                    const p2 = path.points[i + 1];
                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    const segLen = Math.sqrt(dx * dx + dy * dy);

                    if (currentDist + segLen >= sampleDist) {
                        labelX = p1.x + dx * 0.5;
                        labelY = p1.y + dy * 0.5;
                        break;
                    }
                    currentDist += segLen;
                }

                if (idx === 0) { labelX -= 40; }
                if (idx === 2) { labelX += 40; }
                if (idx === 1) { labelY -= 20; }
                if (idx === 3) { labelY += 25; }

                let displayTemp = path.tempBase;
                if (power > 0) {
                    if (idx === 1) displayTemp += (power / 100) * 15;
                    if (idx === 3) displayTemp -= (power / 100) * 5;
                }

                ctx.font = "bold 12px Arial";
                const text = displayTemp.toFixed(1) + "¬∞C";
                const textW = ctx.measureText(text).width;

                ctx.fillStyle = "rgba(255,255,255,0.9)";
                ctx.strokeStyle = path.color;
                ctx.lineWidth = 1;

                ctx.beginPath();
                ctx.roundRect(labelX - textW / 2 - 4, labelY - 10, textW + 8, 20, 4);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = "#0f172a";
                ctx.fillText(text, labelX, labelY);
            });
        }

        function updatePhysics() {
            let target = 0;
            let rate = 0.0;

            if (power > 0) {
                const coolingPotential = (power / 100) * (outdoorTemp - 16);
                target = outdoorTemp - coolingPotential;
                rate = 0.05;
            } else {
                target = outdoorTemp;
                rate = 0.02;
            }

            const diff = target - roomTemp;
            if (Math.abs(diff) > 0.1) {
                roomTemp += diff * rate * 0.1;
            }
            indoorTempDisplay.innerText = roomTemp.toFixed(1) + "¬∞C";
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            paths.forEach(drawPipePath);
            drawComponents();
            drawParticles();
            drawFloatLabels();

            if (frameCount % 10 === 0) {
                updatePhysics();
            }

            frameCount++;
            requestAnimationFrame(animate);
        }

        powerSlider.addEventListener('input', (e) => {
            power = parseInt(e.target.value, 10);
            powerValueText.innerText = power + "%";

            if (power === 0) {
                powerValueText.className = "text-slate-400";
            } else if (power < 50) {
                powerValueText.className = "text-blue-500";
            } else {
                powerValueText.className = "text-blue-700 font-bold";
            }
        });

        if (!ctx.roundRect) {
            ctx.roundRect = function (x, y, w, h, r) {
                this.beginPath();
                this.moveTo(x + r, y);
                this.lineTo(x + w - r, y);
                this.quadraticCurveTo(x + w, y, x + w, y + r);
                this.lineTo(x + w, y + h - r);
                this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                this.lineTo(x + r, y + h);
                this.quadraticCurveTo(x, y + h, x, y + h - r);
                this.lineTo(x, y + r);
                this.quadraticCurveTo(x, y, x + r, y);
                this.closePath();
            };
        }

        init();

    </script>
</body>

</html>